<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basketball Math Superstar Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --court-brown: #b5651d;
            --court-line: rgba(255, 255, 255, 0.9);
            --hoop-orange: #ff4500;
        }
        body {
            font-family: 'Quicksand', sans-serif;
            touch-action: manipulation;
            overflow: hidden;
            background-color: #87CEEB;
        }
        .math-font { font-family: 'Fredoka One', cursive; }
        
        /* Hi·ªáu ·ª©ng b·∫ßu tr·ªùi v√† m√¢y tr√¥i */
        .sky-bg {
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
            position: absolute;
            inset: 0;
            z-index: 1;
        }
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.9;
            filter: blur(3px);
            animation: float linear infinite;
        }
        @keyframes float {
            from { transform: translateX(-250px); }
            to { transform: translateX(100vw); }
        }

        /* Thi·∫øt k·∫ø s√¢n b√≥ng r·ªï r·ªông h∆°n */
        .court-floor {
            background-color: var(--court-brown);
            position: relative;
            border-top: 10px solid #8b4513;
            overflow: hidden;
            z-index: 2;
        }
        .court-lines {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }
        .arc-3pt {
            position: absolute;
            top: -250px;
            left: 50%;
            transform: translateX(-50%);
            width: 900px; /* R·ªông h∆°n */
            height: 900px;
            border: 6px solid var(--court-line);
            border-radius: 50%;
        }
        .the-paint {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 320px; /* R·ªông h∆°n */
            height: 250px;
            border: 6px solid var(--court-line);
            border-top: none;
        }
        .free-throw-circle {
            position: absolute;
            top: 170px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
            border: 6px solid var(--court-line);
            border-radius: 50%;
        }

        /* B·∫£ng r·ªï */
        .backboard-container {
            width: 380px;
            height: 260px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(12px);
            border: 6px solid #fff;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }
        .math-header {
            width: 95%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #math-display {
            font-size: 2.2rem;
            color: #333;
            font-weight: 700;
        }
        #tts-btn {
            background: #4facfe;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
            flex-shrink: 0;
            cursor: pointer;
            border: 2px solid white;
        }
        #tts-btn:active { transform: scale(0.8); }

        .hoop-rim {
            width: 120px;
            height: 28px;
            border: 8px solid var(--hoop-orange);
            border-radius: 50%;
            margin-top: 50px;
            position: relative;
            z-index: 20;
            box-shadow: 0 8px 0 rgba(0,0,0,0.2);
        }
        .hoop-net {
            width: 110px;
            height: 100px;
            background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.4) 10px, rgba(255,255,255,0.4) 11px),
                        repeating-linear-gradient(-45deg, transparent, transparent 10px, rgba(255,255,255,0.4) 10px, rgba(255,255,255,0.4) 11px);
            clip-path: polygon(0% 0%, 100% 0%, 80% 100%, 20% 100%);
            margin-top: -10px;
            z-index: 5;
        }

        /* Qu·∫£ b√≥ng r·ªï 3D n·ªïi b·∫≠t */
        .ball-3d {
            background: radial-gradient(circle at 35% 35%, #ff9d6c 0%, #ff6b1a 50%, #b34200 100%);
            box-shadow: inset -10px -10px 30px rgba(0,0,0,0.5), 0 20px 25px rgba(0,0,0,0.4);
            position: absolute;
            z-index: 999;
            pointer-events: none;
        }
        .ball-line-h {
            position: absolute;
            top: 50%;
            width: 100%;
            height: 4px;
            background: rgba(0,0,0,0.35);
            transform: translateY(-50%);
        }
        .ball-line-v {
            position: absolute;
            left: 50%;
            height: 100%;
            width: 4px;
            background: rgba(0,0,0,0.35);
            transform: translateX(-50%);
        }

        .btn-option {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            z-index: 50;
        }
        .btn-option:hover { transform: scale(1.05); }

        .screen {
            position: absolute;
            inset: 0;
            z-index: 5;
        }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center p-0 m-0 select-none">
<img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <div id="game-container" class="relative w-full max-w-5xl h-full max-h-[900px] overflow-hidden bg-white shadow-2xl flex flex-col">
        
        <!-- Layer N·ªÅn -->
        <div class="sky-bg">
            <div class="cloud w-40 h-14 top-10" style="animation-duration: 45s; left: -10%"></div>
            <div class="cloud w-56 h-20 top-32" style="animation-duration: 70s; left: -25%"></div>
            <div class="cloud w-28 h-10 top-60" style="animation-duration: 55s; left: -15%"></div>
        </div>

        <!-- UI Score & Question Status -->
        <div class="absolute top-6 left-6 right-6 flex justify-between items-center z-[60] pointer-events-none">
            <div class="bg-white/90 backdrop-blur-md rounded-2xl px-6 py-3 flex items-center gap-3 border-4 border-yellow-400 shadow-lg">
                <span class="text-3xl">‚≠ê</span>
                <span id="star-count" class="text-3xl font-bold text-orange-600 math-font">0</span>
            </div>
            <div id="round-indicator" class="bg-white/90 backdrop-blur-md rounded-2xl px-6 py-3 text-xl font-bold text-blue-600 border-4 border-blue-400 shadow-lg">
                Question: 1/10
            </div>
        </div>

        <!-- M√†n h√¨nh B·∫Øt ƒë·∫ßu -->
        <div id="screen-menu" class="screen flex flex-col items-center justify-center">
            <div class="bg-white/95 p-12 rounded-[4rem] shadow-2xl border-[12px] border-orange-500 text-center">
                <h1 class="text-6xl md:text-7xl math-font text-orange-600 mb-2">MATH QUEST</h1>
                <p class="text-2xl font-bold text-blue-500 uppercase tracking-widest mb-10">Advanced Basketball</p>
                <div class="w-40 h-40 ball-3d relative rounded-full mx-auto mb-10 animate-bounce flex items-center justify-center overflow-hidden" style="position: relative; z-index: 1;">
                    <div class="ball-line-h"></div><div class="ball-line-v"></div>
                </div>
                <button onclick="startGame()" class="bg-orange-500 hover:bg-orange-600 text-white text-5xl px-16 py-8 rounded-full shadow-[0_12px_0_rgb(154,52,18)] transition-all transform hover:scale-110 active:translate-y-2 math-font">
                    PLAY NOW!
                </button>
            </div>
        </div>

        <!-- M√†n h√¨nh Ch∆°i To√°n -->
        <div id="screen-game" class="screen hidden flex flex-col">
            <div class="h-1/2 relative flex items-center justify-center pt-24">
                <div class="backboard-container">
                    <div class="math-header">
                        <div id="math-display" class="math-font">12 + 5 =</div>
                        <button id="tts-btn" title="Listen">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div id="hoop-rim" class="hoop-rim"></div>
                    <div class="hoop-net"></div>
                </div>
            </div>

            <div class="h-1/2 court-floor flex flex-col items-center justify-around pb-12">
                <div class="court-lines">
                    <div class="arc-3pt"></div>
                    <div class="the-paint"></div>
                    <div class="free-throw-circle"></div>
                </div>
                <div id="answer-container" class="flex flex-wrap justify-center gap-8 px-6 relative z-10"></div>
                <!-- Anchor Position - ƒê·∫©y xu·ªëng th·∫•p h∆°n ƒë·ªÉ kh√¥ng che ƒë√°p √°n -->
                <div id="ball-anchor" class="w-full h-12 flex justify-center mb-4 relative"></div>
            </div>

            <div id="basketball" class="w-32 h-32 ball-3d rounded-full flex items-center justify-center border-4 border-black/10 transition-transform overflow-hidden">
                <div class="ball-line-h"></div>
                <div class="ball-line-v"></div>
            </div>

            <div id="feedback-overlay" class="absolute inset-0 pointer-events-none flex items-center justify-center opacity-0 transition-opacity duration-300 z-[1000]">
                <div id="feedback-content" class="text-9xl transform scale-50 transition-transform duration-500 drop-shadow-2xl">üåü</div>
            </div>
        </div>

        <!-- M√†n h√¨nh chuy·ªÉn mini-game -->
        <div id="screen-rewards" class="screen hidden bg-blue-600/95 flex flex-col items-center justify-center p-8 text-center text-white">
            <div id="fireworks-container" class="absolute inset-0 pointer-events-none"></div>
            <div class="relative z-10">
                <h2 class="text-7xl math-font text-yellow-300 mb-4 animate-pulse">AMAZING!</h2>
                <p class="text-3xl mb-12">You are a Math Superstar!</p>
                <button onclick="startMiniGame()" class="bg-orange-500 p-8 rounded-[3rem] shadow-[0_10px_0_rgb(194,65,12)] hover:scale-105 transition-all text-3xl font-bold uppercase math-font">
                    PLAY CANDY BURST! üç¨
                </button>
            </div>
        </div>

        <!-- M√†n h√¨nh Breakout Candy -->
        <div id="screen-minigame" class="screen hidden bg-[#fffde7] flex flex-col">
            <div class="p-4 bg-white/80 backdrop-blur-md flex justify-between items-center text-gray-800 border-b-4 border-yellow-200">
                <div class="flex items-center gap-4">
                    <span class="text-2xl font-bold math-font uppercase text-orange-500 tracking-widest">CANDY BURST</span>
                    <span id="minigame-level" class="bg-orange-100 text-orange-600 px-3 py-1 rounded-lg font-bold">LEVEL 1</span>
                </div>
                <span id="minigame-score" class="text-3xl font-mono text-blue-600 font-bold">0</span>
            </div>
            <div id="minigame-canvas-container" class="flex-1 relative flex items-center justify-center overflow-hidden">
                <canvas id="minigame-canvas"></canvas>
                <!-- Th√¥ng b√°o L√™n Level -->
                <div id="level-up-msg" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-6xl text-orange-600 math-font animate-bounce pointer-events-none">
                    LEVEL UP! üöÄ
                </div>
                <div id="minigame-over" class="hidden absolute inset-0 bg-white/90 flex flex-col items-center justify-center text-center">
                    <h3 class="text-7xl text-red-500 math-font mb-4">GAME OVER!</h3>
                    <p id="final-score-text" class="text-4xl text-gray-700 mb-12 font-bold">Your Score: 0</p>
                    <button onclick="summary()" class="bg-blue-500 text-white text-4xl px-16 py-6 rounded-full math-font shadow-lg hover:bg-blue-600 transition-colors">CONTINUE</button>
                </div>
            </div>
        </div>

        <!-- M√†n h√¨nh T·ªïng k·∫øt cu·ªëi c√πng -->
        <div id="screen-summary" class="screen hidden bg-gradient-to-b from-blue-700 to-indigo-900 flex flex-col items-center justify-center p-8 text-center text-white">
            <div id="summary-fireworks" class="absolute inset-0 pointer-events-none"></div>
            <h2 class="text-7xl math-font text-yellow-400 mb-6">WELL DONE!</h2>
            <div class="bg-white/10 backdrop-blur-xl rounded-[4rem] p-12 shadow-2xl border-4 border-white/20 mb-12">
                 <p class="text-3xl mb-4 text-blue-100">Final Stars Earned:</p>
                 <div id="summary-stars" class="text-9xl text-yellow-400 font-bold mb-6 math-font">‚≠ê 30</div>
                 <p id="summary-final-score" class="text-2xl text-white/70">Score from Candy Burst: 0</p>
            </div>
            <button onclick="resetGame()" class="bg-orange-500 text-white text-4xl px-16 py-8 rounded-full shadow-[0_12px_0_rgb(154,52,18)] hover:scale-110 active:translate-y-2 transition-all math-font">
                PLAY AGAIN
            </button>
        </div>
    </div>

    <script>
        const apiKey = "";
        const state = {
            stars: 0,
            questionIndex: 0,
            questions: [],
            totalQuestions: 10,
            isAnimating: false,
            minigameScore: 0,
            minigameLevel: 1,
            cleanup: null,
            wasWrong: false
        };

        const ball = document.getElementById('basketball');
        const mathDisplay = document.getElementById('math-display');
        const answerContainer = document.getElementById('answer-container');
        const starCountDisplay = document.getElementById('star-count');
        const roundIndicator = document.getElementById('round-indicator');
        const ttsBtn = document.getElementById('tts-btn');

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'correct') {
                osc.frequency.setValueAtTime(523, now);
                osc.frequency.exponentialRampToValueAtTime(1046, now + 0.5);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(120, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(); osc.stop(now + 0.3);
            } else if (type === 'hit') {
                osc.frequency.setValueAtTime(440, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'swish') {
                const bufferSize = audioCtx.sampleRate * 0.2;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const src = audioCtx.createBufferSource();
                src.buffer = buffer;
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'bandpass'; filter.frequency.value = 1000;
                src.connect(filter); filter.connect(gain);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                src.start(); src.stop(now + 0.2);
            }
        }

        function createQ(isAdd) {
            let a, b, res;
            if (isAdd) {
                res = Math.floor(Math.random() * 11) + 10;
                a = Math.floor(Math.random() * (res - 3)) + 2;
                b = res - a;
            } else {
                a = Math.floor(Math.random() * 6) + 15;
                res = Math.floor(Math.random() * 6) + 10;
                b = a - res;
            }
            let opts = [res];
            while(opts.length < 3) {
                let alt = res + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random()*2)+1);
                if (alt >= 0 && !opts.includes(alt)) opts.push(alt);
            }
            return {
                text: `${a} ${isAdd ? '+' : '-'} ${b} =`,
                speech: `${nToW(a)} ${isAdd ? 'plus' : 'minus'} ${nToW(b)} equals`,
                ans: res,
                opts: opts.sort(() => Math.random() - 0.5)
            };
        }

        function nToW(n) {
            const words = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen", "twenty"];
            return words[n] || n;
        }

        // ‚úÖ S·ª≠a l·∫°i TTS d√πng m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát ƒë·ªÉ ·ªïn ƒë·ªãnh h∆°n
        function speak() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const q = state.questions[state.questionIndex];
            if (!q) return;

            window.speechSynthesis.cancel(); // Ng·∫Øt ti·∫øng tr∆∞·ªõc ƒë√≥
            const utter = new SpeechSynthesisUtterance(q.speech);
            utter.lang = "en-US";
            utter.rate = 0.85; // ƒê·ªçc ch·∫≠m cho b√© d·ªÖ nghe
            utter.pitch = 1.1; 
            window.speechSynthesis.speak(utter);
        }

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            state.stars = 0; state.questionIndex = 0;
            state.questions = Array.from({length:10}, (_, i) => createQ(i < 5)).sort(() => Math.random() - 0.5);
            starCountDisplay.textContent = "0";
            showScreen('screen-game');
            loadQ();
        }

        function loadQ() {
            if (state.questionIndex >= state.totalQuestions) { 
                showScreen('screen-rewards'); 
                fireworks('fireworks-container'); 
                return; 
            }
            const q = state.questions[state.questionIndex];
            state.isAnimating = false;
            state.wasWrong = false;
            mathDisplay.textContent = q.text;
            roundIndicator.textContent = `Question: ${state.questionIndex + 1}/${state.totalQuestions}`;
            answerContainer.innerHTML = '';
            q.opts.forEach(v => {
                const b = document.createElement('div');
                b.className = "btn-option w-28 h-28 bg-white rounded-3xl border-b-8 border-gray-300 flex items-center justify-center text-4xl font-bold text-gray-800 shadow-xl";
                b.textContent = v;
                b.onclick = () => check(v, b);
                answerContainer.appendChild(b);
            });
            
            resetBallPosition();
        }

        function resetBallPosition() {
            const anchor = document.getElementById('ball-anchor').getBoundingClientRect();
            const container = document.getElementById('game-container').getBoundingClientRect();
            ball.style.transition = 'none';
            ball.style.opacity = '1';
            ball.style.left = (anchor.left - container.left + (anchor.width / 2) - 64) + 'px';
            ball.style.top = (anchor.top - container.top) + 'px';
            ball.style.transform = 'translate(0,0) scale(1)';
        }

        function check(v, el) {
            if (state.isAnimating) return;
            state.isAnimating = true;
            const isCorrect = v === state.questions[state.questionIndex].ans;
            
            const hoopRect = document.getElementById('hoop-rim').getBoundingClientRect();
            const ballRect = ball.getBoundingClientRect();

            if (isCorrect) {
                const dx = (hoopRect.left + hoopRect.width / 2) - (ballRect.left + ballRect.width / 2);
                const dy = (hoopRect.top - ballRect.top) - 80;
                
                ball.style.transition = 'transform 0.6s cubic-bezier(0.25, 1, 0.5, 1)';
                ball.style.transform = `translate(${dx}px, ${dy}px) scale(0.6)`;
                
                setTimeout(() => {
                    playSound('swish');
                    ball.style.transition = 'transform 0.4s ease-in';
                    ball.style.transform = `translate(${dx}px, ${dy + 150}px) scale(0.6)`;
                    setTimeout(() => {
                        ball.style.transition = 'transform 0.3s ease-out';
                        ball.style.transform = `translate(${dx + 30}px, ${dy + 120}px) scale(0.6)`;
                        playSound('correct');
                        showFeedback('üåü');
                        
                        if (!state.wasWrong) {
                            state.stars += 3;
                            starCountDisplay.textContent = state.stars;
                        }
                        
                        state.questionIndex++;
                        setTimeout(loadQ, 800);
                    }, 400);
                }, 600);
            } else {
                state.wasWrong = true;
                const dx = ((hoopRect.left + hoopRect.width / 2) - (ballRect.left + ballRect.width / 2)) * 0.7;
                const dy = (hoopRect.top - ballRect.top) - 60;
                ball.style.transition = 'transform 0.5s ease-out';
                ball.style.transform = `translate(${dx}px, ${dy}px) scale(0.8)`;
                setTimeout(() => {
                    ball.style.transition = 'transform 0.6s ease-in';
                    ball.style.transform = `translate(${dx - 80}px, 400px) rotate(-180deg)`;
                    playSound('wrong');
                    showFeedback('‚ùå');
                    
                    setTimeout(() => {
                        state.isAnimating = false;
                        resetBallPosition();
                        el.style.opacity = "0.5";
                        el.style.pointerEvents = "none";
                    }, 800);
                }, 500);
            }
        }

        function showFeedback(emoji) {
            const o = document.getElementById('feedback-overlay');
            const c = document.getElementById('feedback-content');
            c.textContent = emoji; o.style.opacity = '1';
            c.style.transform = 'scale(1.5)';
            setTimeout(() => { o.style.opacity = '0'; c.style.transform = 'scale(0.5)'; }, 1000);
        }

        // --- MINI GAME: BREAKOUT CANDY ---
        function startMiniGame() {
            state.minigameScore = 0;
            state.minigameLevel = 1;
            showScreen('screen-minigame');
            document.getElementById('minigame-over').classList.add('hidden');
            document.getElementById('minigame-level').textContent = "LEVEL 1";
            const cv = document.getElementById('minigame-canvas');
            const ct = document.getElementById('minigame-canvas-container');
            cv.width = ct.clientWidth; cv.height = ct.clientHeight;
            initBreakout(cv, 1);
        }

        function initBreakout(canvas, level) {
            const ctx = canvas.getContext('2d');
            const ballSpeed = 6 + (level * 1.5);
            let b = { x: canvas.width/2, y: canvas.height - 100, dx: ballSpeed, dy: -ballSpeed, r: 14 };
            let p = { w: 180, h: 25, x: canvas.width/2 - 90 };
            let drops = [];
            const rows = 4 + (level > 1 ? 1 : 0); // Level 2 c√≥ th√™m 1 h√†ng g·∫°ch
            const cols = 8;
            const pad = 15; const offT = 60;
            const w = (canvas.width - (cols + 1) * pad) / cols;
            const h = 45;
            let bricks = [];
            let totalBricks = 0;

            for (let c = 0; c < cols; c++) {
                bricks[c] = [];
                for (let r = 0; r < rows; r++) {
                    bricks[c][r] = { x: 0, y: 0, s: 1, c: `hsl(${(r * 30 + (level * 60))}, 80%, 60%)` };
                    totalBricks++;
                }
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // V·∫Ω B√≥ng
                ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
                ctx.fillStyle = "#ff6b1a"; ctx.fill(); ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.stroke();

                // V·∫Ω Thanh ƒë·ª°
                ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.roundRect(p.x, canvas.height - 40, p.w, p.h, 15); ctx.fill();
                ctx.strokeStyle = "#fff"; ctx.stroke();

                // V·∫Ω G·∫°ch
                let activeBricks = 0;
                for (let c = 0; c < cols; c++) {
                    for (let r = 0; r < rows; r++) {
                        let br = bricks[c][r];
                        if (br.s === 1) {
                            br.x = c * (w + pad) + pad; br.y = r * (h + pad) + offT;
                            ctx.fillStyle = br.c; ctx.beginPath(); ctx.roundRect(br.x, br.y, w, h, 10); ctx.fill();
                            ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.stroke();
                            activeBricks++;
                        }
                    }
                }

                // N·∫øu ph√° h·∫øt g·∫°ch -> Qua Level
                if (activeBricks === 0) {
                    cancelAnimationFrame(state.cleanup);
                    if (level === 1) {
                        state.minigameLevel = 2;
                        document.getElementById('minigame-level').textContent = "LEVEL 2";
                        const msg = document.getElementById('level-up-msg');
                        msg.classList.remove('hidden');
                        setTimeout(() => {
                            msg.classList.add('hidden');
                            initBreakout(canvas, 2);
                        }, 2000);
                        return;
                    } else {
                        gameOver();
                        return;
                    }
                }

                // X·ª≠ l√Ω Items (Burst)
                drops.forEach((d, idx) => {
                    d.x += d.vx; d.y += d.vy; d.vy += 0.15; 
                    ctx.save();
                    ctx.font = "34px Arial";
                    let emoji = d.type === 'bomb' ? 'üí£' : (d.type === 'med' ? '‚ûï' : 'üç¨');
                    ctx.shadowBlur = 12;
                    ctx.shadowColor = (d.type === 'bomb' || d.type === 'med') ? "red" : "gold";
                    ctx.fillText(emoji, d.x - 15, d.y);
                    ctx.restore();

                    if (d.y > canvas.height - 50 && d.x > p.x && d.x < p.x + p.w) {
                        if (d.type === 'candy') { 
                            state.minigameScore += 100; playSound('correct'); 
                        } else if (d.type === 'bomb') { 
                            state.minigameScore = Math.max(0, state.minigameScore - 200); 
                            p.w = Math.max(60, p.w - 40); playSound('wrong'); 
                        } else if (d.type === 'med') {
                            p.w = Math.min(350, p.w + 70); playSound('correct');
                        }
                        drops.splice(idx, 1);
                        document.getElementById('minigame-score').textContent = state.minigameScore;
                    }
                    if (d.y > canvas.height) drops.splice(idx, 1);
                });

                // V·∫≠t l√Ω va ch·∫°m t∆∞·ªùng
                if (b.x + b.dx > canvas.width - b.r || b.x + b.dx < b.r) b.dx = -b.dx;
                if (b.y + b.dy < b.r) b.dy = -b.dy;
                
                // Va ch·∫°m thanh ƒë·ª°
                if (b.y + b.dy > canvas.height - 40 - b.r) {
                    if (b.x > p.x && b.x < p.x + p.w) { 
                        b.dy = -Math.abs(b.dy); 
                        // Th√™m m·ªôt ch√∫t g√≥c l·ªách d·ª±a tr√™n v·ªã tr√≠ va ch·∫°m
                        b.dx = (b.x - (p.x + p.w/2)) * 0.15;
                        playSound('hit'); 
                    } else if (b.y > canvas.height) { 
                        gameOver(); 
                        return; 
                    }
                }

                // Va ch·∫°m g·∫°ch
                for (let c = 0; c < cols; c++) {
                    for (let r = 0; r < rows; r++) {
                        let br = bricks[c][r];
                        if (br.s === 1 && b.x > br.x && b.x < br.x + w && b.y > br.y && b.y < br.y + h) {
                            b.dy = -b.dy; br.s = 0;
                            state.minigameScore += 20;
                            document.getElementById('minigame-score').textContent = state.minigameScore;
                            playSound('hit');
                            
                            // Hi·ªáu ·ª©ng Tung t√≥e (Bomb 70%, Candy 20%, Medicine 10%)
                            const count = Math.floor(Math.random() * 2) + 1; 
                            for(let i=0; i<count; i++) {
                                const rand = Math.random();
                                let type = 'bomb'; 
                                if (rand < 0.10) type = 'med'; 
                                else if (rand < 0.30) type = 'candy'; 
                                
                                drops.push({ 
                                    x: br.x + w/2, y: br.y + h/2, 
                                    vx: (Math.random() - 0.5) * 10, vy: -4 - Math.random() * 5, 
                                    type: type
                                });
                            }
                        }
                    }
                }
                b.x += b.dx; b.y += b.dy;
                state.cleanup = requestAnimationFrame(draw);
            }

            const move = (e) => {
                const r = canvas.getBoundingClientRect();
                const x = (e.clientX || (e.touches && e.touches[0].clientX)) - r.left;
                p.x = Math.max(0, Math.min(canvas.width - p.w, x - p.w/2));
            };
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); }, {passive:false});
            draw();
        }

        function gameOver() {
            cancelAnimationFrame(state.cleanup);
            document.getElementById('minigame-over').classList.remove('hidden');
            document.getElementById('final-score-text').textContent = `Your Final Score: ${state.minigameScore}`;
        }

        function summary() { 
            showScreen('screen-summary'); 
            document.getElementById('summary-stars').textContent = `‚≠ê ${state.stars}`;
            document.getElementById('summary-final-score').textContent = `Score from Candy Burst: ${state.minigameScore}`;
            fireworks('summary-fireworks'); // B·∫Øn ph√°o hoa khi t·ªïng k·∫øt
        }

        function resetGame() { showScreen('screen-menu'); }
        
        function showScreen(id) {
            if (state.cleanup) { cancelAnimationFrame(state.cleanup); state.cleanup = null; }
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if (id !== 'screen-game') ball.style.opacity = '0';
        }

        function fireworks(targetId) {
            const container = document.getElementById(targetId);
            container.innerHTML = '';
            for(let i=0; i<10; i++) {
                setTimeout(() => {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * window.innerHeight;
                    const col = `hsl(${Math.random()*360}, 100%, 50%)`;
                    for(let j=0; j<25; j++) {
                        const f = document.createElement('div');
                        f.style.cssText = `position:absolute;width:6px;height:6px;border-radius:50%;left:${x}px;top:${y}px;background:${col};z-index:2000;`;
                        container.appendChild(f);
                        const a = Math.random()*Math.PI*2; const d = Math.random()*180+50;
                        f.animate([{transform:'translate(0,0)', opacity:1}, {transform:`translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`, opacity:0}], {duration:1500, easing:'ease-out'});
                    }
                }, i*300);
            }
        }

        ttsBtn.onclick = (e) => { 
            e.stopPropagation();
            speak(); 
        };
        
        window.onload = () => {
            window.addEventListener('click', () => { if (audioCtx.state === 'suspended') audioCtx.resume(); }, { once: true });
            showScreen('screen-menu');
        };
    </script>
</body>
</html>
