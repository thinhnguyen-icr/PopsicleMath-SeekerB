<!doctype html>
<html lang="en">
<head>
  <link rel="stylesheet" href="../assets/brand.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lesson 16 ‚Ä¢ First semester exam </title>
  <style>
    :root{
      --bg1:#edf5ff; --bg2:#f7fff4;
      --card: rgba(255,255,255,.95);
      --border: rgba(148,163,184,.25);
      --text:#0f172a; --muted:#64748b;
      --accent:#2563eb; --accent2:#06b6d4;
      --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b;
      --shadow: 0 18px 45px rgba(15, 23, 42, .12);
      --shadow2: 0 10px 25px rgba(15, 23, 42, .08);
      --radius: 24px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Comic Sans MS", "Chalkboard SE", system-ui, -apple-system, sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 15% 8%, rgba(37,99,235,.15), transparent 55%),
        radial-gradient(900px 520px at 85% 12%, rgba(6,182,212,.15), transparent 55%),
        radial-gradient(700px 420px at 70% 82%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      min-height: 100vh;
    }
    .card{
      background: var(--card);
      border:2px solid #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative; /* For canvas positioning */
      z-index: 1;
    }
    header{
      padding: 14px 16px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.65);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid rgba(148,163,184,.25);
      background: linear-gradient(135deg, #eff6ff, #e0f2fe);
      box-shadow: var(--shadow2);
      font-size:24px;
    }
    .t b{display:block;font-size:16px;letter-spacing:.2px}
    .t span{display:block;font-size:13px;color:var(--muted);margin-top:2px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      border:1px solid var(--border);
      background: #fff;
      border-radius: 999px;
      padding: 6px 12px;
      font-size:13px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display:flex;gap:6px;align-items:center;
      user-select:none;
      white-space:nowrap;
      font-weight: 600;
    }

    /* Left */
    .left{ display:flex; flex-direction:column; min-height: 640px; }
    .left .body{ padding: 16px; }
    .big{ font-weight:950; font-size:20px; margin: 4px 0 8px; letter-spacing:.2px; color: #1e293b; }
    .sub{ color:var(--muted); font-size:14px; line-height:1.5; }
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 16px; }
    .btn{
      border:none;
      background: #fff;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 14px;
      cursor:pointer;
      box-shadow: 0 4px 0 rgba(148,163,184,.2);
      border: 1px solid rgba(148,163,184,.2);
      transition:.1s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      font-weight: 700;
      color: var(--text);
    }
    .btn:active{transform: translateY(2px); box-shadow:none;}
    .btn:hover{background:#f8fafc;}
    
    .btn.primary{
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white; border:none;
      box-shadow: 0 4px 0 #1d4ed8;
    }
    .btn.primary:hover{ filter: brightness(1.1); }
    
    .btn.danger{
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white; border:none;
      box-shadow: 0 4px 0 #b91c1c;
    }

    .progress{
      margin-top: 16px;
      border:1px solid rgba(148,163,184,.25);
      border-radius: 16px;
      padding: 14px;
      background: #fff;
    }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 8px; }
    .meter{ height: 12px; background: #e2e8f0; border-radius: 999px; overflow:hidden; }
    .bar{
      height:100%; width:0%;
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      border-radius: 999px; transition: .3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .small{ font-size:13px; color: var(--muted); }

    .skillbox{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }
    .skill{
      border:1px solid #e2e8f0;
      border-radius: 12px;
      padding: 8px 12px;
      background: #f8fafc;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .skill b{font-size:13px}
    .skill span{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    .pill{
      font-size:12px;
      border:1px solid transparent;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight:800;
    }
    .pill.ok{ background: #dcfce7; color: #166534; }
    .pill.bad{ background: #fee2e2; color: #991b1b; }
    .pill.mid{ background: #fef3c7; color: #92400e; }

    /* Right */
    .right{ display:flex; flex-direction:column; min-height: 640px; }
    .stage{ padding: 14px; flex:1; }
    .panel{
      height:100%;
      border:1px solid rgba(148,163,184,.20);
      border-radius: 20px;
      padding: 20px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 10px 30px rgba(0,0,0,.05);
      position:relative;
      overflow:hidden;
      display: flex; flex-direction: column;
    }
    .qtop{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 16px; }
    .qtitle{ font-weight:950; font-size:18px; letter-spacing:.2px; color: #334155; }
    .tag{
      font-size:12px;color: #475569;
      border:1px solid #cbd5e1;
      background: #f1f5f9;
      padding: 4px 10px;
      border-radius: 6px;
      white-space:nowrap; font-weight: 600;
    }
    .question{
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    .prompt{ font-size:20px; font-weight:800; line-height:1.3; margin: 0 0 10px; color: #1e293b; display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .speak-btn{
      background: #e0f2fe; border: 1px solid #bae6fd;
      color: #0284c7; border-radius: 50%; width: 36px; height: 36px;
      display:grid; place-items:center; cursor:pointer; font-size:18px;
      transition: .2s; box-shadow: 0 2px 0 #bae6fd;
    }
    .speak-btn:hover{ transform: scale(1.1); background: #bae6fd; }
    .speak-btn:active{ transform: scale(0.95); box-shadow: none; }

    .hint{ color: #64748b; font-size: 14px; margin-top: 8px; font-style: italic; }

    .choices{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: auto;
    }
    .choice{
      border: 2px solid #e2e8f0;
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      cursor:pointer;
      box-shadow: 0 4px 0 #cbd5e1;
      transition:.1s;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 20px;
      font-weight: 900;
      user-select:none;
      min-height: 70px;
      color: #334155;
    }
    .choice:active{ transform: translateY(4px); box-shadow: none; }
    .choice:hover:not(:disabled){ border-color: #94a3b8; }
    
    .choice.selected{ 
      border-color: #3b82f6; background: #eff6ff; color: #2563eb;
      box-shadow: 0 4px 0 #60a5fa;
    }
    .choice:disabled{ cursor:default; opacity: 1; transform:none; box-shadow:none; border-width: 1px;}
    .choice.correct{ border-color: #22c55e; background: #f0fdf4; color: #15803d; }
    .choice.wrong{ border-color: #ef4444; background: #fef2f2; color: #b91c1c; opacity: 0.6; }

    .nav{
      margin-top: 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .gridNav{
      margin-top: 20px;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      padding: 10px; background: #f8fafc;
      border-radius: 12px;
    }
    .dot{
      border:1px solid #e2e8f0;
      background: #fff;
      border-radius: 8px;
      padding: 8px 0;
      font-weight: 700;
      cursor:pointer;
      font-size: 14px;
      color: #64748b;
      transition: .1s;
    }
    .dot:hover{ background: #e2e8f0; }
    .dot.cur{ border-color: #3b82f6; color: #2563eb; background: #eff6ff; border-width:2px; }
    .dot.answered{ background: #dcfce7; color: #15803d; border-color: #86efac; }
    .dot.flag{ border-color: #f59e0b; color: #b45309; background: #fef3c7; }

    /* Count items grid */
    .count-grid{
      display:flex; flex-wrap:wrap; gap:12px; justify-content:center;
      padding: 10px;
    }
    .count-item{ font-size: 32px; animation: popIn .4s cubic-bezier(0.175, 0.885, 0.32, 1.275) backwards; }
    @keyframes popIn { from{transform:scale(0);opacity:0} to{transform:scale(1);opacity:1} }

    /* Clock */
    .two-cols{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items:center; }
    .clock{
      width: 200px; height: 200px; margin: 4px auto;
      border-radius: 50%;
      background: #fff;
      border: 8px solid #dbeafe;
      box-shadow: 0 10px 20px rgba(0,0,0,.05);
      position:relative;
    }
    .clock .center{
      width:14px;height:14px;border-radius:50%;
      background:#1e293b;
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
      z-index: 10;
    }
    .hand{ position:absolute; left:50%; top:50%; border-radius: 99px; transform-origin: 50% 100%; }
    .hand.minute{ 
      width:6px; height: 80px; background: #06b6d4; z-index:3;
      transform: translateX(-50%) translateY(-100%) rotate(0deg); 
    }
    .hand.hour{ 
      width:8px; height: 55px; background: #2563eb; z-index:4;
      transform: translateX(-50%) translateY(-100%) rotate(0deg); 
    }
    /* Fixed tick marks */
    .tick{
      position:absolute; left:50%; top:50%;
      width:4px; height:10px;
      background: #cbd5e1;
      border-radius: 2px;
      /* Positioning logic handled in JS via transform */
    }
    .num{
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
      font-weight: 800; color: #475569; font-size: 14px;
    }

    /* End report */
    .end{
      display:grid;
      place-items:center;
      text-align:center;
      height:100%;
      padding: 20px;
      align-content: center;
      position: relative;
      z-index: 5;
    }
    .end h2{ margin: 12px 0 8px; font-size: 28px; color: #1e293b; }
    .end p{ color: #64748b; margin: 0 0 20px; line-height:1.6; font-size: 16px;}
    .reviewBox{
      width:100%;
      text-align:left;
      border:1px solid #e2e8f0;
      background: #f8fafc;
      border-radius: 16px;
      padding: 12px;
      margin-top: 16px;
      max-height: 400px;
      overflow-y: auto;
    }
    .reviewItem{
      padding:12px;
      border-radius: 12px;
      border:1px solid #f1f5f9;
      background: #fff;
      margin-bottom: 10px;
    }
    .reviewItem b{display:block; font-size:14px; margin-bottom:4px;}
    .reviewItem .m{color:#475569;font-size:13px;margin-bottom:6px;}
    .reviewItem .a{font-size:13px; font-weight:600}
    .okTxt{color:#16a34a}
    .badTxt{color:#ef4444}

    /* Fireworks Canvas */
    #fireworks {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .choices{ grid-template-columns: 1fr; }
      .two-cols{ grid-template-columns: 1fr; }
      .gridNav{ grid-template-columns: repeat(6, 1fr); }
      .clock{ width: 180px; height: 180px; }
    }
  </style>
</head>

<body>
  <img src="../assets/logo-oodles-math.png" class="oodles-logo">
  <div class="wrap">
    <!-- LEFT -->
    <section class="card left">
      <header>
        <div class="brand">
          <div class="logo">üìù</div>
          <div class="t">
            <b>Lesson 16 ‚Ä¢ First semester exam</b>
            <span>Online Test ‚Ä¢ Auto Score</span>
          </div>
        </div>
        <div class="chips">
          <div class="chip" id="chipTimer">‚è± 08:00</div>
          <div class="chip" id="chipStatus">üß© 0 / 12</div>
        </div>
      </header>

      <div class="body">
        <div class="big">Semester 1 Test (12 Questions)</div>
        <div class="sub">
          Rules: <b>Select one answer</b> per question. <b>No retries</b>. Auto-submit when time is up.
        </div>

        <div class="btnrow">
          <button class="btn primary" id="startBtn">‚ñ∂ Start Test</button>
          <button class="btn ghost" id="resetBtn">üîÑ Reset</button>
        </div>

        <div class="progress">
          <div class="row">
            <div class="small"><b>Progress</b></div>
            <div class="small" id="mini">Not started</div>
          </div>
          <div class="meter"><div class="bar" id="bar"></div></div>
        </div>

        <div class="progress" style="margin-top:12px">
          <div class="row" style="margin-bottom:6px">
            <div class="small"><b>Skill Breakdown</b></div>
            <div class="small" id="breakHint">Shown after submission</div>
          </div>
          <div class="skillbox" id="skillBox"></div>
        </div>

        <div class="progress" style="margin-top:12px">
          <div class="small">
            üí° Tip: Kids can do this alone or in pairs. Teacher reads, kid selects.
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card right">
      <header>
        <div class="brand">
          <div class="logo">üéØ</div>
          <div class="t">
            <b>First semester Questions</b>
            <span>Select answer then click Next</span>
          </div>
        </div>
        <div class="chips">
          <div class="chip" id="chipScore">‚≠ê Score: ‚Äî</div>
          <div class="chip" id="chipLevel">üè∑ Level: ‚Äî</div>
        </div>
      </header>

      <div class="stage">
        <div class="panel">

          <div class="end" id="welcome">
            <div>
              <div style="font-size:60px; margin-bottom: 20px;">üß†</div>
              <h2>First semester exam</h2>
              <p>Press <b>Start Test</b> to begin. You have <b>08:00</b> minutes.</p>
            </div>
          </div>

          <div id="quiz" style="display:none;">
            <div class="qtop">
              <div class="qtitle" id="qTitle">Question</div>
              <div class="tag" id="qTag">Skill</div>
            </div>

            <div class="question" id="qBox"></div>
            <div class="choices" id="choices"></div>

            <div class="nav">
              <button class="btn" id="flagBtn" style="color:#b45309; border-color:#f59e0b">üö© Flag</button>
              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn" id="prevBtn">‚Üê Prev</button>
                <button class="btn primary" id="nextBtn">Next ‚Üí</button>
              </div>
            </div>

            <div class="gridNav" id="gridNav"></div>

            <div class="nav" style="margin-top:10px; justify-content: flex-end;">
              <button class="btn danger" id="submitBtn">‚úÖ Submit Test</button>
            </div>
          </div>

          <div class="end" id="finish" style="display:none;">
            <canvas id="fireworks"></canvas>
            <div style="position:relative; z-index:2; background:rgba(255,255,255,0.9); padding:20px; border-radius:20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
              <div style="font-size:60px; margin-bottom: 10px;">üèÜ</div>
              <h2 id="finalTitle">Test Submitted!</h2>
              <p id="finalText">...</p>
              <div class="btnrow" style="justify-content:center;">
                <button class="btn primary" id="reviewBtn">üëÄ Review Answers</button>
                <button class="btn" id="newBtn">‚ñ∂ New Attempt</button>
              </div>

              <div class="reviewBox" id="reviewBox" style="display:none;"></div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </div>

<script>
  // --- Sound Effects & TTS ---
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  
  function playTone(freq, type, duration, vol=0.1) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  function sfxClick() { playTone(400, 'sine', 0.1, 0.05); } 
  function sfxSelect() { playTone(600, 'triangle', 0.1, 0.05); } 
  function sfxNav() { playTone(300, 'sine', 0.1, 0.03); } 
  function sfxSubmit() { 
    playTone(523.25, 'sine', 0.1, 0.1); 
    setTimeout(()=> playTone(659.25, 'sine', 0.1, 0.1), 100);
    setTimeout(()=> playTone(783.99, 'sine', 0.4, 0.1), 200);
    setTimeout(()=> playTone(1046.50, 'sine', 0.6, 0.1), 300);
  }

  // --- Fireworks System ---
  let fwLoop = null;
  const fwCanvas = document.getElementById("fireworks");
  const fwCtx = fwCanvas.getContext("2d");
  let particles = [];

  function resizeCanvas() {
    if(fwCanvas.parentElement){
        fwCanvas.width = fwCanvas.parentElement.offsetWidth;
        fwCanvas.height = fwCanvas.parentElement.offsetHeight;
    }
  }

  function createFirework(x, y) {
    const count = 40; // Increased count
    const color = `hsl(${Math.random()*360}, 100%, 50%)`;
    for (let i = 0; i < count; i++) {
      const angle = (Math.PI * 2 * i) / count;
      const speed = Math.random() * 4 + 2; // Faster
      particles.push({
        x: x, y: y,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        alpha: 1,
        color: color,
        decay: Math.random() * 0.015 + 0.015
      });
    }
  }

  function updateFireworks() {
    // Semi-transparent clear for trail effect
    fwCtx.globalCompositeOperation = 'destination-out';
    fwCtx.fillStyle = 'rgba(0, 0, 0, 0.1)'; 
    fwCtx.fillRect(0, 0, fwCanvas.width, fwCanvas.height);
    
    fwCtx.globalCompositeOperation = 'source-over';

    // Add new random firework frequently
    if(Math.random() < 0.08) { // Increased frequency
      createFirework(Math.random() * fwCanvas.width, Math.random() * fwCanvas.height * 0.6);
    }

    for (let i = particles.length - 1; i >= 0; i--) {
      let p = particles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.08; // gravity
      p.alpha -= p.decay;

      fwCtx.globalAlpha = p.alpha;
      fwCtx.fillStyle = p.color;
      fwCtx.beginPath();
      fwCtx.arc(p.x, p.y, 3, 0, Math.PI * 2);
      fwCtx.fill();

      if (p.alpha <= 0) particles.splice(i, 1);
    }
    fwCtx.globalAlpha = 1;
    fwLoop = requestAnimationFrame(updateFireworks);
  }

  function startFireworks() {
    // Important: Resize MUST happen after the element is visible
    setTimeout(() => {
        resizeCanvas();
        particles = [];
        // Initial burst
        createFirework(fwCanvas.width/2, fwCanvas.height/2);
        createFirework(fwCanvas.width/4, fwCanvas.height/3);
        createFirework(fwCanvas.width*0.75, fwCanvas.height/3);
        
        if(fwLoop) cancelAnimationFrame(fwLoop);
        updateFireworks();
    }, 100);
  }

  function stopFireworks() {
    if(fwLoop) cancelAnimationFrame(fwLoop);
    fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
  }

  function speak(text) {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      utterance.rate = 0.9;
      window.speechSynthesis.speak(utterance);
    }
  }

  // ===== Skills (First semester exam) =====
  const SKILLS = [
    { key:"count",  name:"Counting to 20" },
    { key:"ord",    name:"Ordinal Numbers" },
    { key:"pat",    name:"Patterns" },
    { key:"ten",    name:"Tens & Ones" },
    { key:"numPat", name:"Number Patterns" },
    { key:"add",    name:"Addition" },
    { key:"graph",  name:"Picture Graph" },
    { key:"sub",    name:"Subtraction" },
    { key:"time",   name:"Time" },
  ];

  const rand = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
  const shuffle = (arr)=> arr.map(v=>({v, r:Math.random()})).sort((a,b)=>a.r-b.r).map(x=>x.v);

  // ===== Question Builders (12 questions) =====

  // 1. Counting: Show items to count (10-20)
  function qCounting(){
    const n = rand(10, 20); 
    const item = ["üçé","‚≠ê","üéà","üçÑ","üç™"][rand(0,4)];
    
    let itemsHtml = "";
    for(let i=0; i<n; i++) itemsHtml += `<div class="count-item">${item}</div>`;

    const wrongs = shuffle([n+1, n-1, n+2].filter(x=>x>0)).slice(0,2);
    
    const text = `How many ${item} are there?`;
    return {
      skill:"count", tag:"üî¢ Counting",
      prompt: text,
      html:`<div class="prompt">${text}<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
            <div class="count-grid">${itemsHtml}</div>
            <div class="hint">Count one by one.</div>`,
      choices: shuffle([String(n), ...wrongs.map(String)]),
      answer: String(n)
    };
  }

  // 2. Counting: Compare (10-20)
  function qCounting2(){
    const a = rand(12,20);
    const b = a - rand(1,5);
    const ask = `Which number is bigger?`;
    const right = a;
    const wrong = b;
    return {
      skill:"count", tag:"üî¢ Counting",
      prompt:ask,
      html:`<div class="prompt">${ask}<button class="speak-btn" onclick="speak('${ask}')">üîä</button></div>
            <div style="display:flex;gap:12px;justify-content:center;margin-top:10px">
              <div style="font-size:44px;font-weight:950;border:1px solid #cbd5e1;background:#fff;padding:10px 16px;border-radius:18px; color:#475569">${a}</div>
              <div style="font-size:44px;font-weight:950;border:1px solid #cbd5e1;background:#fff;padding:10px 16px;border-radius:18px; color:#475569">${b}</div>
            </div>
            <div class="hint">Choose the bigger number.</div>`,
      choices: shuffle([String(right), String(wrong), String(right+1)]),
      answer: String(right)
    };
  }

  // 3. Ordinal: 10 different animals
  function qOrdinal(){
    const pool = ["üê∂","üê±","üê∞","ü¶ä","üêº","üêØ","üê∏","ü¶Å","üêÆ","üê®"];
    const rowAnimals = shuffle(pool).slice(0,10);
    const pos = rand(1,10); 
    const ordMap = {1:"1st",2:"2nd",3:"3rd",4:"4th",5:"5th", 6:"6th",7:"7th",8:"8th",9:"9th",10:"10th"};
    const ordStr = ordMap[pos];
    const targetAnimal = rowAnimals[pos-1];

    const rowHtml = rowAnimals.map(a => `<span style="font-size:32px;margin:0 2px">${a}</span>`).join("");
    
    const wrongs = shuffle(rowAnimals.filter(x=>x!==targetAnimal)).slice(0,2);
    const text = `Which animal is ${ordStr}?`;

    return {
      skill:"ord", tag:"ü•á Ordinal",
      prompt: text,
      html:`<div class="prompt">Which animal is <span style="color:var(--accent);margin:0 6px">${ordStr}</span>?<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
            <div style="text-align:center;padding:10px 0;background:#f8fafc;border-radius:12px">${rowHtml}</div>
            <div class="hint">Count from left to right ‚Üí</div>`,
      choices: shuffle([targetAnimal, ...wrongs]),
      answer: targetAnimal
    };
  }

  // 4. Patterns: Circle, Square, Triangle, Rectangle (SVG)
  function qPatterns(){
    const type = rand(0,2);
    const circle = `<svg width="46" height="46" viewBox="0 0 40 40" style="vertical-align:middle"><circle cx="20" cy="20" r="16" fill="#ef4444" /></svg>`;
    const square = `<svg width="46" height="46" viewBox="0 0 40 40" style="vertical-align:middle"><rect x="6" y="6" width="28" height="28" fill="#3b82f6" rx="4" /></svg>`;
    const triangle = `<svg width="46" height="46" viewBox="0 0 40 40" style="vertical-align:middle"><polygon points="20,6 34,34 6,34" fill="#f59e0b" stroke-linejoin="round" stroke-width="4" stroke="#f59e0b"/></svg>`;
    const rect = `<svg width="46" height="46" viewBox="0 0 40 40" style="vertical-align:middle"><rect x="4" y="10" width="32" height="20" fill="#10b981" rx="4" /></svg>`;
    
    const shapes = [circle, square, triangle, rect];
    
    let A = shapes[rand(0,3)];
    let B = shapes[rand(0,3)];
    while(B===A) B = shapes[rand(0,3)];
    let C = shapes[rand(0,3)];
    while(C===A || C===B) C = shapes[rand(0,3)];

    let seq = [];
    let ans = "";
    
    if(type===0) { seq = [A,B,A,B,A]; ans = B; }
    else if(type===1) { seq = [A,B,C,A,B]; ans = C; }
    else { seq = [A,A,B,A,A]; ans = B; }

    const wrongs = shapes.filter(x=>x!==ans).slice(0,2);
    const text = "What comes next?";

    return {
      skill:"pat", tag:"üß© Pattern",
      prompt: text,
      html:`<div class="prompt">${text}<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
            <div style="text-align:center;padding:10px 0; display:flex; justify-content:center; gap:4px; align-items:center;">
              ${seq.join("")}
            </div>
            <div class="hint">Look at the repeating pattern.</div>`,
      choices: shuffle([ans, ...wrongs]),
      answer: ans
    };
  }

  function qTensOnes(){
    const n = rand(11,19);
    const ones = n - 10;
    const cells = [];
    for(let i=0;i<10;i++) cells.push(`<div style="width:100%;aspect-ratio:1/1;border-radius:50%;border:1px dashed #cbd5e1;display:grid;place-items:center;background:#f8fafc"><div style="width:18px;height:18px;border-radius:999px;background:#22c55e;box-shadow:0 3px 0 #15803d"></div></div>`);
    for(let i=0;i<ones;i++) cells.push(`<div style="width:100%;aspect-ratio:1/1;border-radius:50%;border:1px dashed #cbd5e1;display:grid;place-items:center;background:#f8fafc"><div style="width:18px;height:18px;border-radius:999px;background:#3b82f6;box-shadow:0 3px 0 #1d4ed8"></div></div>`);
    while(cells.length < 20) cells.push(`<div style="width:100%;aspect-ratio:1/1;border-radius:50%;border:1px dashed #cbd5e1;background:#fff"></div>`);

    const wrongs = shuffle([n+1, n-1, n+2].filter(x=>x>=10 && x<=20)).slice(0,2);
    const text = "How many dots?";
    return {
      skill:"ten", tag:"üßÆ Tens & Ones",
      prompt: text,
      html:`<div class="two-cols">
              <div>
                <div class="prompt">How many?<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
                <div class="hint">Green = 10, Blue = Ones.</div>
              </div>
              <div style="width:260px;margin:0 auto;display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:12px;border:1px solid #e2e8f0;border-radius:18px;background:#fff">
                ${cells.join("")}
              </div>
            </div>`,
      choices: shuffle([String(n), ...wrongs.map(String)]),
      answer: String(n)
    };
  }

  function qNumberPattern(){
    const type = rand(0, 2);
    const A = rand(1, 9);
    let B = rand(1, 9); while(B===A) B = rand(1,9);
    let C = rand(1, 9); while(C===A || C===B) C = rand(1,9);
    
    let seq = [];
    let ans = 0;
    
    if(type === 0) { seq = [A, B, A, B, A]; ans = B; }
    else if (type === 1) { seq = [A, B, C, A, B, C, A]; ans = B; }
    else { seq = [A, A, B, A, A, B, A]; ans = A; }

    const wrongs = shuffle([ans+1, ans-1, ans+2].filter(x=>x>0)).slice(0,2);
    const text = "What number comes next?";
    
    return {
      skill:"numPat", tag:"üìà Number pattern",
      prompt: text,
      html:`<div class="prompt">${text}<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
            <div style="text-align:center;font-size:40px;font-weight:950;padding:10px 0; color:#334155">
              ${seq.join(" , ")} , <span style="color:var(--accent)">?</span>
            </div>
            <div class="hint">Look for the repeating pattern.</div>`,
      choices: shuffle([String(ans), ...wrongs.map(String)]),
      answer: String(ans)
    };
  }

  function qAddition(){
    const a = rand(6,10), b = rand(6,10);
    const ans = a + b; 
    const wrongs = shuffle([ans+1, ans-1, ans+2].filter(x=>x!==ans)).slice(0,2);
    const text = `There are ${a} apples and ${b} more apples. How many in total?`;
    return {
      skill:"add", tag:"‚ûï Addition",
      prompt:`Story addition`,
      html:`<div class="prompt">Story time!<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
            <div style="font-size:16px;font-weight:900;line-height:1.4">
              There are <span style="color:var(--accent)">${a}</span> apples üçé and <span style="color:var(--accent2)">${b}</span> more apples üçé.<br>
              How many apples in total?
            </div>
            <div class="hint">${a} + ${b} = ?</div>`,
      choices: shuffle([String(ans), ...wrongs.map(String)]),
      answer: String(ans)
    };
  }

  function qAddition2(){
    const a = rand(10,15), b = rand(1,5);
    const ans = a + b;
    const wrongs = shuffle([ans+1, ans-1, ans+2].filter(x=>x!==ans)).slice(0,2);
    const text = `${a} plus ${b} equals what?`;
    return {
      skill:"add", tag:"‚ûï Addition",
      prompt:`Addition`,
      html:`<div class="prompt">Add<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
            <div style="text-align:center;font-size:52px;font-weight:950;margin:8px 0; color:#2563eb">${a} + ${b} = ?</div>`,
      choices: shuffle([String(ans), ...wrongs.map(String)]),
      answer: String(ans)
    };
  }

  function qGraph(){
    const items = [
      {name:"Cats", icon:"üê±"},
      {name:"Dogs", icon:"üê∂"},
      {name:"Fish", icon:"üê†"},
    ];
    let counts = shuffle([2,3,4,5]).slice(0,3);
    const data = items.map((it,i)=>({ ...it, n: counts[i] }));
    const maxItem = data.reduce((m,x)=> x.n>m.n?x:m, data[0]);

    const graphHtml = data.map(d=>{
      const icons = Array.from({length:d.n}, ()=>`<span style="width:20px;height:20px;border-radius:4px;background:#e0f2fe;display:grid;place-items:center;font-size:12px">${d.icon}</span>`).join("");
      return `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 6px;border-radius:12px;background:#f8fafc;border:1px solid #e2e8f0;margin-bottom:8px">
          <div style="display:flex;align-items:center;gap:10px;font-weight:900"><span style="font-size:20px">${d.icon}</span> ${d.name}</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">${icons}</div>
        </div>
      `;
    }).join("");

    const wrongs = shuffle(data.filter(d=>d.name!==maxItem.name)).slice(0,2).map(d=>d.name);
    const text = "Which group has the most?";

    return {
      skill:"graph", tag:"üìä Picture graph",
      prompt: text,
      html:`<div class="two-cols">
              <div>
                <div class="prompt">Which has the most?<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
                <div class="hint">Count the icons.</div>
              </div>
              <div style="width:280px;margin:0 auto;padding:12px;border:1px solid #e2e8f0;border-radius:18px;background:#fff">
                ${graphHtml}
              </div>
            </div>`,
      choices: shuffle([maxItem.name, ...wrongs]),
      answer: maxItem.name
    };
  }

  function qSub(){
    const total = rand(12,20);
    const take = rand(2, 5);
    const ans = total - take;
    const wrongs = shuffle([ans+1, ans-1, ans+2].filter(x=>x>=0 && x!==ans)).slice(0,2);
    const text = `You have ${total} balloons. ${take} fly away. How many left?`;
    return {
      skill:"sub", tag:"‚ûñ Subtraction",
      prompt:`Story subtraction`,
      html:`<div class="prompt">How many left?<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
            <div style="font-size:16px;font-weight:900;line-height:1.4">
              You have <span style="color:var(--accent)">${total}</span> balloons üéà.<br>
              <span style="color:var(--accent2)">${take}</span> balloons fly away üí®.<br>
              How many balloons left?
            </div>
            <div class="hint">${total} ‚àí ${take} = ?</div>`,
      choices: shuffle([String(ans), ...wrongs.map(String)]),
      answer: String(ans)
    };
  }

  function qSub2(){
    const a = rand(15,20);
    const b = rand(1,9);
    const ans = a - b;
    const wrongs = shuffle([ans+1, ans-1, ans+2].filter(x=>x>=0 && x!==ans)).slice(0,2);
    const text = `${a} minus ${b} equals what?`;
    return {
      skill:"sub", tag:"‚ûñ Subtraction",
      prompt:`Subtract`,
      html:`<div class="prompt">Subtract<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
            <div style="text-align:center;font-size:52px;font-weight:950;margin:8px 0; color:#ef4444">${a} ‚àí ${b} = ?</div>`,
      choices: shuffle([String(ans), ...wrongs.map(String)]),
      answer: String(ans)
    };
  }

  function qTime(){
    const hour = rand(1,12);
    const answer = `${hour}:00`;
    const wrongs = shuffle([((hour%12)+1), (hour===1?12:hour-1), (hour+2>12?hour-10:hour+2)])
      .slice(0,2).map(h=>`${h}:00`);

    const hourDeg = hour * 30;

    const ticks = Array.from({length:12}, (_,i)=>{
      const deg = (i*30);
      return `<div class="tick" style="transform: translate(-50%,-50%) rotate(${deg}deg) translate(0,-88px);"></div>`;
    }).join("");
    
    const nums = Array.from({length:12}, (_,i)=>{
      const n = i+1;
      const deg = n*30;
      const r = 75;
      const x = Math.sin((deg*Math.PI)/180)*r;
      const y = -Math.cos((deg*Math.PI)/180)*r;
      return `<div class="num" style="transform: translate(${x}px, ${y}px) translate(-50%,-50%);">${n}</div>`;
    }).join("");

    const text = "What time is it?";
    return {
      skill:"time", tag:"üïí Time (o‚Äôclock)",
      prompt: text,
      html:`<div class="two-cols">
              <div>
                <div class="prompt">What time is it?<button class="speak-btn" onclick="speak('${text}')">üîä</button></div>
                <div class="hint">Minute hand is on 12.</div>
              </div>
              <div class="clock">
                ${ticks}
                ${nums}
                <div class="hand hour" style="transform: translateX(-50%) translateY(-100%) rotate(${hourDeg}deg);"></div>
                <div class="hand minute" style="transform: translateX(-50%) translateY(-100%) rotate(0deg);"></div>
                <div class="center"></div>
              </div>
            </div>`,
      choices: shuffle([answer, ...wrongs]),
      answer
    };
  }

  // Build 12 questions (balanced)
  function buildQuestions(){
    const qs = [
      qCounting(), qCounting2(),
      qOrdinal(),
      qPatterns(),
      qTensOnes(),
      qNumberPattern(),
      qAddition(), qAddition2(),
      qGraph(),
      qSub(), qSub2(),
      qTime(),
    ];
    return qs;
  }

  // ===== State =====
  let QUESTIONS = [];
  let current = 0;
  let answers = []; 
  let flagged = new Set();
  let started = false;
  let submitted = false;

  const TOTAL_SECONDS = 8 * 60; // 08:00
  let leftSec = TOTAL_SECONDS;
  let timerId = null;

  // ===== DOM =====
  const startBtn = document.getElementById("startBtn");
  const resetBtn = document.getElementById("resetBtn");
  const welcome = document.getElementById("welcome");
  const quiz = document.getElementById("quiz");
  const finish = document.getElementById("finish");

  const qTitle = document.getElementById("qTitle");
  const qTag = document.getElementById("qTag");
  const qBox = document.getElementById("qBox");
  const choicesEl = document.getElementById("choices");

  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const flagBtn = document.getElementById("flagBtn");
  const submitBtn = document.getElementById("submitBtn");

  const gridNav = document.getElementById("gridNav");

  const chipTimer = document.getElementById("chipTimer");
  const chipStatus = document.getElementById("chipStatus");
  const chipScore = document.getElementById("chipScore");
  const chipLevel = document.getElementById("chipLevel");

  const mini = document.getElementById("mini");
  const bar = document.getElementById("bar");

  const skillBox = document.getElementById("skillBox");
  const breakHint = document.getElementById("breakHint");

  const finalTitle = document.getElementById("finalTitle");
  const finalText = document.getElementById("finalText");
  const reviewBtn = document.getElementById("reviewBtn");
  const newBtn = document.getElementById("newBtn");
  const reviewBox = document.getElementById("reviewBox");

  function fmtTime(s){
    const m = String(Math.floor(s/60)).padStart(2,"0");
    const sec = String(s%60).padStart(2,"0");
    return `${m}:${sec}`;
  }

  function setBar(pct){ bar.style.width = `${pct}%`; }

  function setStatus(){
    const done = answers.filter(x=>x && x.choice!=null).length;
    chipStatus.textContent = `üß© ${done} / ${QUESTIONS.length}`;
    const pct = Math.round((done/QUESTIONS.length)*100);
    setBar(pct);
    mini.textContent = started ? `In Progress... (${done}/${QUESTIONS.length})` : "Not started";
  }

  function renderGrid(){
    gridNav.innerHTML = "";
    for(let i=0;i<QUESTIONS.length;i++){
      const b = document.createElement("button");
      b.className = "dot";
      if(i===current) b.classList.add("cur");
      if(answers[i] && answers[i].choice!=null) b.classList.add("answered");
      if(flagged.has(i)) b.classList.add("flag");
      b.textContent = i+1;
      b.onclick = ()=> { 
        if(!submitted){ 
          sfxNav();
          current=i; renderQuestion(); 
        } 
      };
      gridNav.appendChild(b);
    }
  }

  function renderQuestion(){
    const q = QUESTIONS[current];
    qTitle.textContent = `Question ${current+1}`;
    qTag.textContent = q.tag;
    qBox.innerHTML = q.html;

    choicesEl.innerHTML = "";
    q.choices.forEach(c=>{
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.type = "button";
      btn.innerHTML = c;

      if(submitted){
        btn.disabled = true;
        if(c === q.answer) btn.classList.add("correct");
        const a = answers[current];
        if(a && a.choice === c && c !== q.answer) btn.classList.add("wrong");
      }else{
        const a = answers[current];
        if(a && a.choice === c) btn.classList.add("selected");
        btn.onclick = ()=> {
          sfxSelect();
          selectChoice(c);
        };
      }

      choicesEl.appendChild(btn);
    });

    flagBtn.textContent = flagged.has(current) ? "üö© Unflag" : "üö© Flag";
    renderGrid();
    setStatus();
  }

  function selectChoice(choice){
    const q = QUESTIONS[current];
    answers[current] = {
      choice,
      correct: choice === q.answer,
      skill: q.skill
    };
    renderQuestion();
  }

  function toggleFlag(){
    sfxClick();
    if(flagged.has(current)) flagged.delete(current);
    else flagged.add(current);
    renderQuestion();
  }

  function tick(){
    leftSec -= 1;
    if(leftSec < 0) leftSec = 0;
    chipTimer.textContent = `‚è± ${fmtTime(leftSec)}`;
    if(leftSec === 0){
      submit(true);
    }
  }

  function start(){
    sfxClick();
    QUESTIONS = buildQuestions();
    answers = Array.from({length:QUESTIONS.length}, ()=> ({choice:null, correct:false, skill:null}));
    flagged = new Set();
    current = 0;
    submitted = false;
    started = true;

    leftSec = TOTAL_SECONDS;
    chipTimer.textContent = `‚è± ${fmtTime(leftSec)}`;

    if(timerId) clearInterval(timerId);
    timerId = setInterval(tick, 1000);

    chipScore.textContent = "‚≠ê Score: ‚Äî";
    chipLevel.textContent = "üè∑ Level: ‚Äî";
    breakHint.textContent = "Shown after submission";
    skillBox.innerHTML = "";

    welcome.style.display = "none";
    finish.style.display = "none";
    quiz.style.display = "block";
    reviewBox.style.display = "none";

    setBar(0);
    mini.textContent = "In Progress...";
    renderQuestion();
  }

  function reset(){
    sfxClick();
    if(timerId) clearInterval(timerId);
    timerId = null;
    stopFireworks(); // Stop fireworks on reset

    started = false;
    submitted = false;
    QUESTIONS = [];
    answers = [];
    flagged = new Set();
    current = 0;
    leftSec = TOTAL_SECONDS;

    chipTimer.textContent = `‚è± ${fmtTime(leftSec)}`;
    chipStatus.textContent = "üß© 0 / 12";
    chipScore.textContent = "‚≠ê Score: ‚Äî";
    chipLevel.textContent = "üè∑ Level: ‚Äî";
    mini.textContent = "Not started";
    setBar(0);

    breakHint.textContent = "Shown after submission";
    skillBox.innerHTML = "";

    quiz.style.display = "none";
    finish.style.display = "none";
    welcome.style.display = "grid";
    reviewBox.style.display = "none";
  }

  function classify(pct){
    if(pct >= 85) return {level:"Excellent", pill:"ok"};
    if(pct >= 70) return {level:"Good", pill:"mid"};
    if(pct >= 50) return {level:"Developing", pill:"mid"};
    return {level:"Needs Practice", pill:"bad"};
  }

  function renderSkillBreakdown(){
    const map = new Map(SKILLS.map(s=>[s.key,{name:s.name, correct:0, total:0}]));
    answers.forEach((a,i)=>{
      const sk = QUESTIONS[i].skill;
      const obj = map.get(sk);
      if(obj){
        obj.total += 1;
        if(a && a.correct) obj.correct += 1;
      }
    });

    skillBox.innerHTML = "";
    for(const s of SKILLS){
      const o = map.get(s.key);
      if(!o || o.total===0) continue;
      const pct = Math.round((o.correct/o.total)*100);
      let pillClass = "bad";
      if(pct === 100) pillClass = "ok";
      else if(pct >= 50) pillClass = "mid";

      const div = document.createElement("div");
      div.className = "skill";
      div.innerHTML = `
        <div>
          <b>${o.name}</b>
          <span>${o.correct}/${o.total} correct</span>
        </div>
        <div class="pill ${pillClass}">${pct}%</div>
      `;
      skillBox.appendChild(div);
    }
    breakHint.textContent = "Results by Skill";
  }

  function submit(fromTimer=false){
    if(submitted || !started) return;
    sfxSubmit();
    
    // Logic order fixed: UI changes FIRST, then Fireworks
    submitted = true;

    if(timerId) clearInterval(timerId);
    timerId = null;

    const correct = answers.filter(a=>a && a.correct).length;
    const total = QUESTIONS.length;
    const pct = Math.round((correct/total)*100);
    const cls = classify(pct);

    chipScore.textContent = `‚≠ê Score: ${correct}/${total}`;
    chipLevel.textContent = `üè∑ Level: ${cls.level}`;

    renderSkillBreakdown();

    quiz.style.display = "none";
    finish.style.display = "grid"; // Make visible first

    // Now start fireworks
    startFireworks();

    finalTitle.textContent = fromTimer ? "Time's up!" : "Test Submitted!";
    finalText.innerHTML = `
      Score: <b>${correct}/${total}</b> (${pct}%)<br>
      Level: <b>${cls.level}</b><br>
      ${fromTimer ? "<span style='color:var(--warn)'>‚è± Auto-submitted (Time's up)</span>" : "<span style='color:var(--ok)'>‚úÖ Completed</span>"}
    `;

    reviewBtn.disabled = false;
  }

  function buildReview(){
    sfxClick();
    reviewBox.innerHTML = "";
    QUESTIONS.forEach((q,i)=>{
      const a = answers[i];
      const ok = a && a.correct;
      const div = document.createElement("div");
      div.className = "reviewItem";
      div.innerHTML = `
        <b>Q${i+1} ‚Ä¢ ${q.tag}</b>
        <div class="m">${q.prompt}</div>
        <div class="a">
          Your answer: <span class="${ok ? "okTxt":"badTxt"}">${a.choice ?? "‚Äî"}</span><br>
          Correct answer: <span class="okTxt">${q.answer}</span>
        </div>
      `;
      reviewBox.appendChild(div);
    });
  }

  // ===== Events =====
  startBtn.onclick = start;
  resetBtn.onclick = reset;

  prevBtn.onclick = ()=> { if(!submitted){ sfxNav(); current = Math.max(0, current-1); renderQuestion(); } };
  nextBtn.onclick = ()=> { if(!submitted){ sfxNav(); current = Math.min(QUESTIONS.length-1, current+1); renderQuestion(); } };
  flagBtn.onclick = ()=> { if(!submitted) toggleFlag(); };

  submitBtn.onclick = ()=> { sfxClick(); submit(false); };

  reviewBtn.onclick = ()=>{
    if(reviewBox.style.display === "none"){
      buildReview();
      reviewBox.style.display = "block";
      reviewBtn.textContent = "üôà Hide Review";
    }else{
      reviewBox.style.display = "none";
      reviewBtn.textContent = "üëÄ Review Answers";
    }
  };

  newBtn.onclick = start;

  reset();
</script>
</body>
</html>
