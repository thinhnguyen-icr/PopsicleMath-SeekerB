<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Racing: Math Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            touch-action: manipulation;
            user-select: none;
        }

        /* --- ROAD & TRACK --- */
        .road-bg {
            background-color: #374151; /* Dark Gray */
            background-image: 
                linear-gradient(90deg, transparent 50%, #ffffff 50%);
            background-size: 100px 100%; 
            position: relative;
            box-shadow: inset 0 10px 20px rgba(0,0,0,0.5);
            border-top: 4px solid #1f2937;
            border-bottom: 4px solid #1f2937;
        }

        .finish-line {
            background: repeating-linear-gradient(
                45deg,
                #000000,
                #000000 10px,
                #ffffff 10px,
                #ffffff 20px
            );
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        }

        /* --- BEAUTIFUL SKY & SUN --- */
        .sky-bg {
            background: linear-gradient(to bottom, #0ea5e9 0%, #38bdf8 40%, #bae6fd 100%);
            position: relative;
            overflow: hidden;
        }

        .sun {
            position: absolute;
            top: -40px;
            left: -40px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, #fde047 20%, #facc15 60%, transparent 70%);
            border-radius: 50%;
            box-shadow: 0 0 40px 20px rgba(253, 224, 71, 0.5);
            animation: sun-glow 4s infinite alternate;
            z-index: 0;
        }

        @keyframes sun-glow {
            from { transform: scale(1); opacity: 0.9; }
            to { transform: scale(1.1); opacity: 1; }
        }

        .cloud-base {
            position: absolute;
            color: white;
            opacity: 0.9;
            text-shadow: 0 4px 10px rgba(0,0,0,0.1);
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.05));
        }
        
        .cloud-move-1 { animation: float 45s infinite linear; }
        .cloud-move-2 { animation: float 35s infinite linear reverse; }
        .cloud-move-3 { animation: float 55s infinite linear; }

        @keyframes float {
            from { transform: translateX(-120px); }
            to { transform: translateX(100vw); }
        }

        .pop-in {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Engine shake animation for moving cars */
        .vroom {
            animation: vroom 0.3s ease-in-out;
        }
        @keyframes vroom {
            0% { transform: translateY(0) scaleX(-1); }
            25% { transform: translateY(-3px) scaleX(-0.95) rotate(-2deg); }
            50% { transform: translateY(0) scaleX(-1.05) rotate(2deg); }
            75% { transform: translateY(-1px) scaleX(-1); }
            100% { transform: translateY(0) scaleX(-1); }
        }
        
        /* Smoke effect for broken car */
        .smoke {
            animation: smoke 1s infinite;
        }
        @keyframes smoke {
            0% { opacity: 0.8; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-20px) scale(1.5); }
        }

        #fireworksCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 60;
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            transform: none !important;
            pointer-events: none;
        }

        ::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="sky-bg h-screen w-screen overflow-hidden flex flex-col items-center relative text-slate-800">
    <img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <!-- Sun & Clouds Background -->
    <div class="sun"></div>
    <!-- Clouds positioned to be visible in the larger sky area -->
    <div class="cloud-base text-7xl cloud-move-1" style="top: 10%; left: -10%;">‚òÅÔ∏è</div>
    <div class="cloud-base text-5xl cloud-move-2" style="top: 15%; right: -10%; opacity: 0.7;">‚òÅÔ∏è</div>
    <div class="cloud-base text-8xl cloud-move-3" style="top: 20%; left: -20%; opacity: 0.6; animation-delay: -20s;">‚òÅÔ∏è</div>
    
    <!-- Game Header -->
    <header class="w-full p-4 flex justify-between items-center z-10 max-w-4xl">
        <div class="bg-white/90 backdrop-blur rounded-2xl px-4 py-2 border-4 border-yellow-400 shadow-lg">
            <span class="text-2xl font-bold text-yellow-600">‚è±Ô∏è Time: <span id="timer">00:00</span></span>
        </div>
        <button id="muteBtn" class="bg-white/90 p-2 rounded-full border-2 border-slate-300 hover:bg-slate-100 transition">
            üîä
        </button>
    </header>

    <!-- Start Screen Overlay -->
    <div id="startScreen" class="absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-md w-[95%] text-center shadow-2xl border-8 border-blue-400 pop-in max-h-[90vh] overflow-y-auto">
            <h1 class="text-4xl sm:text-5xl font-bold text-blue-600 mb-2">Math Racing</h1>
            <h2 class="text-xl sm:text-2xl font-semibold text-orange-500 mb-4">Range 10-20</h2>
            
            <div class="flex justify-center gap-8 mb-4 text-6xl">
                <div class="animate-bounce" style="animation-delay: 0s">üöô</div>
                <div class="animate-bounce" style="animation-delay: 0.2s">üèéÔ∏è</div>
            </div>

            <!-- Time Selection -->
            <div class="mb-4 bg-blue-50 p-3 rounded-xl border-2 border-blue-100">
                <label class="block text-slate-600 mb-1 font-bold text-base">‚è≥ Game Duration:</label>
                <div class="flex justify-center items-center gap-2">
                    <input type="range" id="timeSlider" min="1" max="10" value="3" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <span id="timeDisplay" class="font-bold text-xl text-blue-600 min-w-[3ch]">3m</span>
                </div>
            </div>

            <p class="text-base text-slate-600 mb-4">Choose a game mode:</p>
            
            <div class="flex flex-col gap-3">
                <button onclick="startGame('cpu')" class="w-full bg-green-500 hover:bg-green-600 text-white text-xl sm:text-2xl font-bold py-3 px-6 rounded-2xl shadow-[0_5px_0_rgb(21,128,61)] active:shadow-[0_2px_0_rgb(21,128,61)] active:translate-y-1 transition transform flex items-center justify-center gap-3">
                    <span>üë§ vs ü§ñ</span> 1 Player
                </button>
                <button onclick="startGame('pvp')" class="w-full bg-orange-500 hover:bg-orange-600 text-white text-xl sm:text-2xl font-bold py-3 px-6 rounded-2xl shadow-[0_5px_0_rgb(194,65,12)] active:shadow-[0_2px_0_rgb(194,65,12)] active:translate-y-1 transition transform flex items-center justify-center gap-3">
                    <span>üë§ vs üë§</span> 2 Players
                </button>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-md w-[90%] text-center shadow-2xl border-8 border-purple-400 pop-in relative z-50">
            <h1 id="winnerText" class="text-4xl font-bold mb-4">Race Finished!</h1>
            <div id="winnerIcon" class="text-8xl mb-6">üèÜ</div>
            <p id="finalScore" class="text-xl text-slate-600 mb-8"></p>
            <button onclick="resetGame()" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold py-3 px-8 rounded-2xl shadow-[0_6px_0_rgb(29,78,216)] active:shadow-[0_2px_0_rgb(29,78,216)] active:translate-y-1 transition transform">
                Play Again ‚Ü∫
            </button>
        </div>
    </div>
    
    <!-- Fireworks Layer -->
    <canvas id="fireworksCanvas"></canvas>

    <!-- Main Game Area -->
    <main class="flex-1 w-full max-w-6xl flex flex-col relative z-0 h-full pb-4 justify-between">
        
        <!-- Racing Track Scene - LOWERED FURTHER -->
        <!-- Increased margin-top to mt-40 sm:mt-64 to push track down substantially -->
        <div class="mt-40 sm:mt-64 relative w-full h-48 sm:h-64 flex flex-col justify-end mb-2 overflow-hidden shrink-0 border-b-4 border-slate-700 shadow-xl">
            <!-- Road -->
            <div class="absolute inset-0 road-bg flex flex-col justify-center">
                <!-- Finish Line -->
                <div class="absolute right-8 top-0 h-full w-8 finish-line z-0"></div>
                
                <!-- Lane 1 (Player 1) -->
                <div class="h-1/2 w-full relative border-b-2 border-dashed border-slate-500 flex items-center">
                    <div id="p1Car" class="absolute left-4 transition-all duration-700 ease-out z-10 text-6xl sm:text-7xl transform scale-x-[-1]" style="left: 2%;">
                        üöô
                        <div id="p1Smoke" class="absolute -top-4 -right-2 text-3xl opacity-0">üí®</div>
                    </div>
                    <div id="p1Label" class="absolute left-2 top-2 bg-blue-600 text-white text-xs px-2 py-0.5 rounded shadow z-20">P1</div>
                </div>

                <!-- Lane 2 (CPU / Player 2) -->
                <div class="h-1/2 w-full relative flex items-center">
                    <div id="p2Car" class="absolute left-4 transition-all duration-700 ease-out z-10 text-6xl sm:text-7xl transform scale-x-[-1]" style="left: 2%;">
                        üèéÔ∏è
                        <div id="p2Smoke" class="absolute -top-4 -right-2 text-3xl opacity-0">üí®</div>
                    </div>
                     <div id="p2Label" class="absolute left-2 top-2 bg-red-600 text-white text-xs px-2 py-0.5 rounded shadow z-20">CPU</div>
                </div>
            </div>
        </div>

        <!-- Dynamic Game Controls Container -->
        <div id="gameControls" class="flex-1 w-full px-4 relative flex gap-4 min-h-0">
            
            <!-- MODE 1: Single Player View (Centered) -->
            <div id="singlePlayerView" class="hidden w-full flex-col items-center justify-center bg-white/60 backdrop-blur-md rounded-t-[2rem] shadow-sm p-4 h-full border-t border-white/50 relative">
                 <!-- Penalty Overlay for Single Player -->
                 <div id="spPenalty" class="hidden absolute inset-0 bg-slate-800/80 rounded-t-[2rem] z-50 flex flex-col items-center justify-center text-white">
                    <div class="text-6xl mb-2">üõë</div>
                    <div class="text-2xl font-bold text-red-400">Engine Stalled!</div>
                    <div class="text-xl">Wait: <span id="spTimerVal">5</span>s</div>
                 </div>

                 <div class="text-center mb-4 sm:mb-8">
                    <p class="text-slate-600 text-sm font-semibold mb-1 uppercase tracking-wider">Solve:</p>
                    <div class="text-5xl sm:text-7xl font-black text-slate-800 bg-white px-6 py-3 rounded-3xl shadow-sm border-4 border-slate-100 flex items-center justify-center gap-3">
                        <span id="spNum1">0</span><span id="spOp" class="text-blue-500">+</span><span id="spNum2">0</span>
                    </div>
                </div>
                <div id="spAnswersGrid" class="grid grid-cols-2 gap-4 w-full max-w-lg"></div>
                <p id="spFeedback" class="mt-4 text-slate-600 text-sm font-medium h-6">Choose correctly to boost!</p>
            </div>

            <!-- MODE 2: Two Player View (Split Screen) -->
            <div id="twoPlayerView" class="hidden w-full flex-row gap-2 sm:gap-4 h-full">
                
                <!-- PLAYER 1 (Left) -->
                <div class="flex-1 bg-blue-100/80 backdrop-blur-md rounded-2xl border-4 border-blue-200 p-2 sm:p-4 flex flex-col items-center justify-center relative shadow-sm overflow-hidden">
                    <!-- P1 Penalty Overlay -->
                    <div id="p1Penalty" class="hidden absolute inset-0 bg-slate-800/80 z-50 flex flex-col items-center justify-center text-white rounded-xl">
                        <div class="text-4xl mb-1">üõë</div>
                        <div class="font-bold text-red-400">Stalled!</div>
                        <div><span id="p1TimerVal">5</span>s</div>
                    </div>

                    <div class="text-blue-700 font-bold mb-2">PLAYER 1</div>
                    <div class="text-3xl sm:text-5xl font-black text-slate-800 bg-white px-4 py-2 rounded-2xl shadow-sm border-2 border-blue-100 flex items-center gap-2 mb-4">
                        <span id="p1Num1">0</span><span id="p1Op">+</span><span id="p1Num2">0</span>
                    </div>
                    <div id="p1Grid" class="grid grid-cols-2 gap-2 w-full max-w-sm"></div>
                </div>

                <!-- PLAYER 2 (Right) -->
                <div class="flex-1 bg-red-100/80 backdrop-blur-md rounded-2xl border-4 border-red-200 p-2 sm:p-4 flex flex-col items-center justify-center relative shadow-sm overflow-hidden">
                    <!-- P2 Penalty Overlay -->
                    <div id="p2Penalty" class="hidden absolute inset-0 bg-slate-800/80 z-50 flex flex-col items-center justify-center text-white rounded-xl">
                        <div class="text-4xl mb-1">üõë</div>
                        <div class="font-bold text-red-400">Stalled!</div>
                        <div><span id="p2TimerVal">5</span>s</div>
                    </div>

                    <div class="text-red-700 font-bold mb-2">PLAYER 2</div>
                    <div class="text-3xl sm:text-5xl font-black text-slate-800 bg-white px-4 py-2 rounded-2xl shadow-sm border-2 border-red-100 flex items-center gap-2 mb-4">
                        <span id="p2Num1">0</span><span id="p2Op">+</span><span id="p2Num2">0</span>
                    </div>
                    <div id="p2Grid" class="grid grid-cols-2 gap-2 w-full max-w-sm"></div>
                </div>

            </div>

        </div>

    </main>

    <script>
        // --- Game Config & State ---
        const TARGET_SCORE = 20; 
        let p1Score = 0;
        let p2Score = 0;
        let gameActive = false;
        let gameMode = 'cpu'; // 'cpu' or 'pvp'
        
        let timeLeft = 180;
        let initialTime = 180;
        let cpuTimer = null;
        let gameTimer = null;
        let isMuted = false;

        // Penalty Timers
        let p1PenaltyTimer = null;
        let p2PenaltyTimer = null;

        // Player States
        let p1State = { num1: 0, num2: 0, ans: 0 };
        let p2State = { num1: 0, num2: 0, ans: 0 };
        let spState = { num1: 0, num2: 0, ans: 0 };

        // --- Audio Context ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'correct') {
                // Racing Car Vroom Sound (Doppler-ish)
                osc.type = 'sawtooth';
                // Start low, rev up high, then fade out
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.2); // Rev up
                osc.frequency.linearRampToValueAtTime(300, now + 0.5); // Doppler drop

                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0.15, now + 0.2);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
                
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'wrong') {
                // Breakdown / Stall
                osc.type = 'square';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(20, now + 0.5);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            } else if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(523, now);
                osc.frequency.setValueAtTime(659, now + 0.2);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 1.0);
                osc.start(now); osc.stop(now + 1.0);
            }
        }

        // --- Fireworks Logic ---
        const canvas = document.getElementById('fireworksCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        function animateFireworks() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, index) => {
                p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.alpha -= 0.015;
                ctx.save(); ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color; 
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI * 2); ctx.fill(); ctx.restore();
                if (p.alpha <= 0) particles.splice(index, 1);
            });
            if (Math.random() < 0.05 && particles.length < 300) {
                 const x = Math.random() * canvas.width;
                 const y = Math.random() * canvas.height / 2;
                 const color = ['#f00','#0f0','#00f','#ff0'][Math.floor(Math.random()*4)];
                 for(let i=0;i<20;i++) {
                     particles.push({x, y, vx: Math.cos(i)*Math.random()*4, vy: Math.sin(i)*Math.random()*4, color, alpha: 1});
                 }
            }
            if (particles.length > 0 || !gameActive) requestAnimationFrame(animateFireworks);
        }

        // --- Time Slider ---
        const timeSlider = document.getElementById('timeSlider');
        timeSlider.addEventListener('input', (e) => {
            document.getElementById('timeDisplay').innerText = `${e.target.value}m`;
        });

        // --- Core Game Functions ---

        function startGame(mode) {
            gameMode = mode;
            const selectedMins = parseInt(document.getElementById('timeSlider').value);
            initialTime = selectedMins * 60;
            
            document.getElementById('startScreen').classList.add('hidden');
            
            // Setup UI based on mode
            if (gameMode === 'cpu') {
                document.getElementById('singlePlayerView').classList.remove('hidden');
                document.getElementById('singlePlayerView').classList.add('flex');
                document.getElementById('twoPlayerView').classList.add('hidden');
                document.getElementById('twoPlayerView').classList.remove('flex');
                document.getElementById('p2Label').innerText = "CPU";
                document.getElementById('p2Label').classList.remove('bg-red-700');
                document.getElementById('p2Label').classList.add('bg-red-500');
            } else {
                document.getElementById('singlePlayerView').classList.add('hidden');
                document.getElementById('singlePlayerView').classList.remove('flex');
                document.getElementById('twoPlayerView').classList.remove('hidden');
                document.getElementById('twoPlayerView').classList.add('flex');
                document.getElementById('p2Label').innerText = "P2";
                document.getElementById('p2Label').classList.remove('bg-red-500');
                document.getElementById('p2Label').classList.add('bg-red-700');
            }

            resetGameState();
            gameActive = true;
            particles = []; // clear fireworks
            
            // Initial Questions
            if (gameMode === 'cpu') {
                generateQuestion('single');
            } else {
                generateQuestion('p1');
                generateQuestion('p2');
            }

            startTimers();
            updateVisuals();
        }

        function resetGame() {
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            particles = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Hide penalties
            document.getElementById('spPenalty').classList.add('hidden');
            document.getElementById('p1Penalty').classList.add('hidden');
            document.getElementById('p2Penalty').classList.add('hidden');
            clearTimeout(p1PenaltyTimer);
            clearTimeout(p2PenaltyTimer);
        }

        function resetGameState() {
            p1Score = 0;
            p2Score = 0;
            timeLeft = initialTime;
            updateTimerDisplay();
        }

        function startTimers() {
            clearInterval(cpuTimer);
            clearInterval(gameTimer);

            if (gameMode === 'cpu') {
                // CPU advances randomly between 3-6 seconds
                function cpuMove() {
                    if (!gameActive) return;
                    if (p2Score < TARGET_SCORE) {
                        p2Score++;
                        // CPU effect
                        document.getElementById('p2Car').classList.add('vroom');
                        setTimeout(() => document.getElementById('p2Car').classList.remove('vroom'), 200);
                        updateVisuals();
                        checkWinCondition();
                        
                        // Random delay for next move (slower than average player)
                        let delay = Math.random() * 3000 + 3000; 
                        cpuTimer = setTimeout(cpuMove, delay);
                    }
                }
                cpuTimer = setTimeout(cpuMove, 2000);
            }

            gameTimer = setInterval(() => {
                if (!gameActive) return;
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    endGame(p1Score > p2Score ? 'p1' : (p2Score > p1Score ? 'p2' : 'draw'));
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }

        // --- Question Generation Logic (Range 10-20, + & -) ---
        function getMathProblem() {
            const isAddition = Math.random() < 0.5;
            
            if (isAddition) {
                // Sum should be between 10 and 20
                // Minimum sum 10: 5+5, 1+9...
                // Maximum sum 20: 10+10, 15+5...
                let sum = Math.floor(Math.random() * 11) + 10; // 10 to 20
                let n1 = Math.floor(Math.random() * (sum - 1)) + 1; // 1 to sum-1
                let n2 = sum - n1;
                return { n1, n2, operator: '+', ans: sum };
            } else {
                // Subtraction: Minuend (n1) between 10 and 20
                let n1 = Math.floor(Math.random() * 11) + 10; // 10 to 20
                let n2 = Math.floor(Math.random() * (n1 - 1)) + 1; // Ensure diff >= 1
                return { n1, n2, operator: '-', ans: n1 - n2 };
            }
        }

        function getOptions(correctVal) {
            let answers = [correctVal];
            while (answers.length < 4) {
                let offset = Math.floor(Math.random() * 6) - 3;
                if (offset === 0) offset = 1;
                let fake = correctVal + offset;
                // Ensure fake answers are positive and within plausible range 0-25
                if (fake >= 0 && fake <= 25 && !answers.includes(fake)) answers.push(fake);
            }
            return answers.sort(() => Math.random() - 0.5);
        }

        function generateQuestion(who) {
            if (!gameActive) return;

            const prob = getMathProblem();
            const opts = getOptions(prob.ans);

            if (who === 'single') {
                spState = { num1: prob.n1, num2: prob.n2, ans: prob.ans };
                document.getElementById('spNum1').innerText = prob.n1;
                document.getElementById('spOp').innerText = prob.operator;
                document.getElementById('spNum2').innerText = prob.n2;
                renderButtons('spAnswersGrid', opts, 'single');
            } else if (who === 'p1') {
                p1State = { num1: prob.n1, num2: prob.n2, ans: prob.ans };
                document.getElementById('p1Num1').innerText = prob.n1;
                document.getElementById('p1Op').innerText = prob.operator;
                document.getElementById('p1Num2').innerText = prob.n2;
                renderButtons('p1Grid', opts, 'p1');
            } else if (who === 'p2') {
                p2State = { num1: prob.n1, num2: prob.n2, ans: prob.ans };
                document.getElementById('p2Num1').innerText = prob.n1;
                document.getElementById('p2Op').innerText = prob.operator;
                document.getElementById('p2Num2').innerText = prob.n2;
                renderButtons('p2Grid', opts, 'p2');
            }
        }

        function renderButtons(gridId, options, type) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';
            
            const btnClass = type === 'single' 
                ? "bg-white border-b-8 border-slate-200 text-slate-700 text-3xl sm:text-5xl font-bold py-4 sm:py-6 rounded-2xl hover:bg-slate-50 hover:border-b-4 hover:translate-y-1 active:border-b-0 active:translate-y-2 transition-all shadow-sm w-full"
                : "bg-white border-b-4 border-slate-200 text-slate-700 text-xl sm:text-3xl font-bold py-3 sm:py-4 rounded-xl hover:bg-slate-50 active:translate-y-1 transition-all shadow-sm w-full";

            options.forEach(ans => {
                const btn = document.createElement('button');
                btn.className = btnClass;
                btn.innerText = ans;
                btn.onclick = () => handleAnswer(ans, btn, type);
                grid.appendChild(btn);
            });
        }

        function handleAnswer(val, btn, type) {
            if (!gameActive) return;
            if (btn.hasAttribute('disabled')) return;

            let correctVal = 0;
            if (type === 'single') correctVal = spState.ans;
            if (type === 'p1') correctVal = p1State.ans;
            if (type === 'p2') correctVal = p2State.ans;

            if (val === correctVal) {
                // CORRECT
                playSound('correct');
                
                // Visual Vroom
                let carId = (type === 'single' || type === 'p1') ? 'p1Car' : 'p2Car';
                document.getElementById(carId).classList.add('vroom');
                setTimeout(() => document.getElementById(carId).classList.remove('vroom'), 300);

                if (type === 'single' || type === 'p1') {
                    p1Score++;
                } else if (type === 'p2') {
                    p2Score++;
                }

                btn.classList.add('bg-green-200', 'border-green-400', 'text-green-700');
                
                if (type === 'single') {
                     document.getElementById('spFeedback').innerText = "Vroom! Boosting!";
                     document.getElementById('spFeedback').className = "mt-4 text-green-600 font-bold pop-in";
                }

                updateVisuals();
                checkWinCondition();
                
                if (gameActive) {
                    setTimeout(() => generateQuestion(type), 300);
                }

            } else {
                // WRONG - PENALTY
                playSound('wrong');
                btn.classList.add('bg-red-200', 'border-red-400', 'text-red-700', 'wiggle');

                if (type === 'single') {
                    startPenalty('single');
                    document.getElementById('spFeedback').innerText = "Engine Stalled! Wait 5s.";
                    document.getElementById('spFeedback').className = "mt-4 text-red-500 font-bold";
                } else if (type === 'p1') {
                    startPenalty('p1');
                } else if (type === 'p2') {
                    startPenalty('p2');
                }
            }
        }

        function startPenalty(who) {
            let overlayId, timerId, carId, smokeId;
            
            if (who === 'single') {
                overlayId = 'spPenalty'; timerId = 'spTimerVal'; carId = 'p1Car'; smokeId = 'p1Smoke';
            } else if (who === 'p1') {
                overlayId = 'p1Penalty'; timerId = 'p1TimerVal'; carId = 'p1Car'; smokeId = 'p1Smoke';
            } else if (who === 'p2') {
                overlayId = 'p2Penalty'; timerId = 'p2TimerVal'; carId = 'p2Car'; smokeId = 'p2Smoke';
            }

            // Show smoke
            document.getElementById(smokeId).classList.add('smoke');

            // Show overlay
            const overlay = document.getElementById(overlayId);
            const timerSpan = document.getElementById(timerId);
            overlay.classList.remove('hidden');
            
            let secondsLeft = 5;
            timerSpan.innerText = secondsLeft;

            const interval = setInterval(() => {
                secondsLeft--;
                timerSpan.innerText = secondsLeft;
                if (secondsLeft <= 0) {
                    clearInterval(interval);
                    overlay.classList.add('hidden');
                    document.getElementById(smokeId).classList.remove('smoke');
                    // Generate new question immediately after penalty so they can start fresh
                    generateQuestion(who); 
                }
            }, 1000);
        }

        function updateVisuals() {
            // Map score (0 to 20) to width % (2% to 90%)
            // We want cars to start at left (2%) and end at right (~90%)
            const maxPos = 90;
            const minPos = 2;
            
            const p1Pos = minPos + (p1Score / TARGET_SCORE) * (maxPos - minPos);
            const p2Pos = minPos + (p2Score / TARGET_SCORE) * (maxPos - minPos);

            document.getElementById('p1Car').style.left = `${Math.min(p1Pos, maxPos)}%`;
            document.getElementById('p2Car').style.left = `${Math.min(p2Pos, maxPos)}%`;
        }

        function checkWinCondition() {
            if (p1Score >= TARGET_SCORE) endGame('p1');
            else if (p2Score >= TARGET_SCORE) endGame('p2');
        }

        function endGame(winner) {
            gameActive = false;
            clearInterval(cpuTimer);
            clearInterval(gameTimer);

            const screen = document.getElementById('gameOverScreen');
            const title = document.getElementById('winnerText');
            const icon = document.getElementById('winnerIcon');
            const scoreText = document.getElementById('finalScore');

            screen.classList.remove('hidden');

            let p1Name = "BLUE CAR";
            let p2Name = gameMode === 'cpu' ? "CPU (RED CAR)" : "RED CAR";

            if (winner === 'p1') {
                playSound('win');
                title.innerText = `${p1Name} WINS!`;
                title.className = "text-4xl font-bold mb-4 text-blue-600";
                icon.innerText = "üèÜ üöô";
                scoreText.innerText = "Fantastic driving!";
                requestAnimationFrame(animateFireworks);
            } else if (winner === 'p2') {
                playSound('win');
                title.innerText = `${p2Name} WINS!`;
                title.className = "text-4xl font-bold mb-4 text-red-600";
                icon.innerText = "ü•á üèéÔ∏è";
                scoreText.innerText = "Better luck next time!";
                requestAnimationFrame(animateFireworks);
            } else {
                playSound('win');
                title.innerText = "IT'S A DRAW!";
                title.className = "text-4xl font-bold mb-4 text-slate-600";
                icon.innerText = "üèÅ";
                scoreText.innerText = `Blue: ${p1Score} - Red: ${p2Score}`;
            }
        }

        document.getElementById('muteBtn').onclick = function() {
            isMuted = !isMuted;
            this.innerText = isMuted ? 'üîá' : 'üîä';
            this.classList.toggle('bg-red-100');
        };

    </script>
</body>
</html>
